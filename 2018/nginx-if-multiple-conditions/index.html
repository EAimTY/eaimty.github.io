<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=#000000 id=color_chrome name=theme-color><meta content=#000000 id=color_safari name=apple-mobile-web-app-status-bar-style><meta content="EAimTY's Blog" name=description><link rel="Shortcut Icon" href=https://www.eaimty.com/favicon.ico><link href=https://www.eaimty.com/favicon.ico rel=Bootmark><link title="EAimTY's Blog" href=https://www.eaimty.com/rss.xml rel=alternate type=application/rss+xml><style>#title,body{line-height:1.6em}body{background:#000;color:#00c000;font-size:1.2em}#container{margin:2.4em auto;width:72%}#header{text-align:center}#header>a{font-size:.96em;margin:auto 1em}#title{font-size:1.6em;font-weight:700;margin:1em auto}#date{font-style:italic}#list>li{margin:.8em auto;list-style:disc}img{max-width:100%}a{color:inherit;text-decoration:none}#content a,a:hover{text-decoration:underline}pre{padding:1em;overflow:auto;background:#1b1d16}:not(pre) >code{padding:.2em;background:#1b1d16;overflow:auto}blockquote{padding:0 1em;margin:0;border-left:.25em solid #212121}@media (max-width:600px){#container{width:88%}#header>a{margin:auto .3em}}</style><title>在 Nginx 的 if 条件中使用“与”、“或” - EAimTY's Blog</title><body><div id=header><a href=https://www.eaimty.com>EAimTY's Blog</a><a href=https://www.eaimty.com/about/>About</a><a href=https://www.eaimty.com/friends/>Friends</a></div><div id=container><a href=https://www.eaimty.com/2018/nginx-if-multiple-conditions/ id=title>在 Nginx 的 if 条件中使用“与”、“或”</a><div id=date>2018-03-24</div><div id=content><p>相比与 Apache，Nginx 的 config 写起来更舒服一些。<p>但是，很多情况下，我们的需求可能会稍稍有些复杂，例如在一个判断语句中使用多个条件。Apache 写这种判断很简单，但使用 Nginx 该如何实现呢？<p>Nginx 中的 if/else 的语法与大多数语言一致：<pre class=language-conf data-lang=conf><code class=language-conf data-lang=conf>if (&LTcondition>) {
    # Do something
} else {
    # Do something
}
</code></pre><p>虽然 Nginx 并非编程语言，我们还是先来试试在其它语言中常用的手段吧。<h1 id=shi-cuo>试错</h1><h2 id=shi-yong-luo-ji-yun-suan-fu>使用逻辑运算符</h2><pre class=language-conf data-lang=conf><code class=language-conf data-lang=conf>if (&LTcondition1> AND &LTcondition2>) {
    # Do something
}
</code></pre><p>用 <code>nginx -t</code> 测试一下，报错...<p>试试用符号？<pre class=language-conf data-lang=conf><code class=language-conf data-lang=conf>if (&LTcondition1> && &LTcondition2>) {
    # Do something
}
</code></pre><p>还是有问题，看来 Nginx 并不支持逻辑运算符。<h2 id=shi-yong-duo-ge-if-kuai-qian-tao>使用多个 if 块嵌套</h2><p>试试“曲线救国”：<pre class=language-conf data-lang=conf><code class=language-conf data-lang=conf>if (&LTcondition1>) {
    if (&LTcondition2>) {
        # Do something
    }
}
</code></pre><p><code>nginx -t</code>，还是报错...<h1 id=zheng-que-de-zi-shi>正确的姿势</h1><p>在网上找了一些文章，终于解决了这个问题。<p>关键就在于：用变量存储状态。<h2 id=huo>“或”</h2><pre class=language-conf data-lang=conf><code class=language-conf data-lang=conf>set $foo 0;
if (&LTcondition1>) {
    set $foo 1;
}
if (&LTcondition2>) {
    set $foo 1;
}
if ($foo = 1) {
    # Do something
}
</code></pre><p>只要两个条件中有任意一个成立，$foo 就会被赋值为 1，最后一个代码块就会被执行。<p>另外，如果“或”用在判断的变量的值时，可以用 <code>|</code> 更简单地解决：<pre class=language-conf data-lang=conf><code class=language-conf data-lang=conf>if ($letter ~ ("A"|"B"|"C"|"D")) {
    # Do something
}
</code></pre><p>但需要注意的是，不能这样写：<pre class=language-conf data-lang=conf><code class=language-conf data-lang=conf>if ($letter ~ ("A"|"B") | $letter ~ ("C"|"D")) {
    # Do something else
}
</code></pre><h2 id=yu>“与”</h2><pre class=language-conf data-lang=conf><code class=language-conf data-lang=conf>set $foo "";
if (&LTcondition1>) {
    set "${foo}1";
}
if (&LTcondition2>) {
    set "${foo}1";
}
if ($foo ~* "11") {
    # Do something
}
</code></pre><p>首先把 $foo 清空，之后每当有一个条件成立，就会在 $foo 的结尾添加一个 1，当 $foo 中的字符串为“11”时，最后的代码块会被执行。<h2 id=geng-duo-ge-tiao-jian-zu-he>更多个条件组合</h2><pre class=language-conf data-lang=conf><code class=language-conf data-lang=conf>set $foo "";
if (&LTcondition1>) {
    set $foo "1";
} else {
    set $foo "0";
}
if (&LTcondition2>) {
    set $foo "${foo}1";
} else {
    set $foo "${foo}0";
}
if ( $foo ~* "011" ) {
    # Do something
}
</code></pre><p>开始时 $foo 是空字符串，每当一个判断成立时 $foo 的最后会被添加一个 1，不成立则添加 0，以此类推，最后一个 if 块中 $foo 要匹配的字符串就是你希望实现的判断。<p>Nginx 的变量字符匹配中，<code>~*</code> 代表匹配，<code>!~*</code> 代表不匹配（实际上都是正则）<h1 id=shuo-liao-zhe-yao-duo-zhe-xie-neng-gan-shi-yao>说了这么多，这些能干什么？</h1><p>举个例子，当我们直接用 Nginx 给 Google Analytics 发送数据时，一般需要考虑两个条件：<ul><li>是否是爬虫<li>用户是否开启 DNT（Do Not Track）</ul><p>这时多条件判断就派上用场了。<p>类似的使用环境有很多。</div><div id=comments-issue-id style=display:none>26</div><div id=comments-addition style=display:none>[{"user":{"login":"老李","avatar_url":"https://secure.gravatar.com/avatar/bb26f0adac7706d47cd9b41a4578a081?d=retro"},"created_at":"2018-04-19T06:53:03Z","body":"我也觉得"},{"user":{"login":"卢本伟","avatar_url":"https://secure.gravatar.com/avatar/18b9d219b84123997366291c235471da?d=retro"},"created_at":"2018-04-10T06:25:36Z","body":"备案略屌"},{"user":{"login":"三七","avatar_url":"https://secure.gravatar.com/avatar/3300499b9f34be851551053d748a2021?d=retro"},"created_at":"2020-12-12T12:36:44Z","body":"学到了，还有判断nginx字段为空的方法$referer ~* \"^$"}]</div><style>#comment-header,#comment-list>li{margin:1em auto}#comment-avatar,#comment-tip{margin:auto .2em}#comment-action-avatar,#comment-avatar{width:1em;height:1em}#comment-action-info>*,#comment-action-input>*,#comment-info>*{display:inline-block;vertical-align:middle}#comment-header{font-size:1.6em;font-weight:700;line-height:1.6em}#comment-tip{font-style:italic}#comment-list{list-style:none;padding:0}#comment-action-author,#comment-author{font-weight:700;margin:auto .4em}#comment-datetime{font-size:.8em;font-style:italic}#comment-body{margin:auto 1.8em}#comment-action-info>*{margin:1em .2em}#comment-action-input{height:2em;width:100%;margin:1em auto}#comment-action-input>*{height:100%;margin:0 .2em}#comment-action-textarea{width:calc(100% - 8em)}#comment-action-post{width:6em}#comment-action-login{margin:1em .3em}</style><ol id=comment-list></ol><div id=comment-action></div><script>const y=e=>{var t=/\\([\\\|`*_{}\[\]()#+\-~])/g,n=/\n *&gt; *([^]*?)(?=(\n|$){2})/g,i=/\n( *)(?:[*\-+]|((\d+)|([a-z])|[A-Z])[.)]) +([^]*?)(?=(\n|$){2})/g,o=/(^|[^A-Za-z\d\\])(([*_])|(~)|(\^)|(--)|(\+\+)|`)(\2?)([^<]*?)\2\8(?!\2)(?=\W|_|$)/g,a=/^.*\n( *\|( *:?-+:?-+:? *\|)* *\n|)/,c=/.*\n/g,m=/\||(.*?[^\\])\|/g;const l=(t,n)=>{e=e.replace(t,n)},d=(e,t)=>"<"+e+">"+t+"</"+e+">",r=e=>e.replace(n,((e,t)=>d("blockquote",r(u(t.replace(/^ *&gt; */gm,"")))))),s=e=>e.replace(i,((e,t,n,i,o,a)=>(e=d("li",u(a.split(RegExp("\n ?"+t+"(?:(?:\\d+|[a-zA-Z])[.)]|[*\\-+]) +","g")).map(s).join("</li><li>"))),"\n"+(n?'<ol start="'+(i?n+'">':parseInt(n,36)-9+'" style="list-style-type:'+(o?"low":"upp")+'er-alpha">')+e+"</ol>":d("ul",e))))),u=e=>e.replace(o,((e,t,n,i,o,a,c,m,l,r)=>t+d(i?l?"strong":"em":o?l?"s":"sub":a?"sup":c?"small":m?"big":"code",u(r))));var p=[],h=0;return e="\n"+e+"\n",l(/</g,"&lt;"),l(/>/g,"&gt;"),l(/\t|\r|\uf8ff/g,"  "),e=r(e),l(/^([*\-=_] *){3,}$/gm,"<hr/>"),e=s(e),l(/<\/(ol|ul)>\n\n<\1>/g,""),l(/\n((```|~~~).*\n?([^]*?)\n?\2|((    .*?\n)+))/g,((e,t,n,i,o)=>(p[--h]=d("pre",d("code",i||o.replace(/^    /gm,""))),h+""))),l(/((!?)\[(.*?)\]\((.*?)( ".*")?\)|\\([\\`*_{}\[\]()#+\-.!~]))/g,((e,n,i,o,a,c,m)=>(p[--h]=a?i?'<img src="'+a+'" alt="'+o+'"/>':'<a href="'+a+'">'+u(o).replace(t,"$1")+"</a>":m,h+""))),l(/&lt;(.*?)&gt;/g,((e,n)=>'<a href="'+n+'">'+u(n).replace(t,"$1")+"</a>")),l(/\n(( *\|.*?\| *\n)+)/g,((e,n)=>{var i=n.match(a)[1];return"\n"+d("table",n.replace(c,((e,n)=>e==i?"":d("tr",e.replace(m,((e,o,a)=>a?d(i&&!n?"th":"td",u(o||"").replace(t,"$1")):""))))))})),l(/(?=^|>|\n)([>\s]*?)(#{1,6}) (.*?)( #*)? *(?=\n|$)/g,((e,n,i,o)=>n+d("h"+i.length,u(o).replace(t,"$1")))),l(/(?=^|>|\n)\s*\n+([^<]+?)\n+\s*(?=\n|<|$)/g,((e,n)=>d("p",u(n).replace(t,"$1")))),l(/-\d+\uf8ff/g,(e=>p[parseInt(e,10)])),e.trim()},f=e=>{let t=t=>e.next(t),n=t=>e.throw(t);return new Promise(((i,o)=>{let a=e=>{e.done?i(e.value):Promise.resolve(e.value).then(t,n).then(a,o)};a(e.next())}))};let g;const m=document.getElementById("comments-issue-id").innerText,n=new URL(window.location.href);let q,p=n.searchParams.get("github_access_token");p&&(document.cookie=`github_access_token=${p};Path=/;Secure;SameSite=Strict`,n.searchParams.delete("github_access_token"),window.location.replace(n)),null!=p||(p=null==(q=document.cookie.split(";").find((e=>e.trim().startsWith("github_access_token="))))?void 0:q.trim().substring(20));const r=()=>{document.cookie="github_access_token=;expires=Thu, 01 Jan 1970 00:00:00 GMT;Path=/;Secure;SameSite=Strict",p=null},t=()=>f(function*(){var e;let n;if(g=JSON.parse(null!=(n=null==(e=document.getElementById("comments-addition"))?void 0:e.innerText)?n:"[]"),p){if(200!==(e=yield fetch(`https://comments.eaimty.com/comments?issue_id=${m}&github_access_token=${p}`,{method:"GET"})).status)return r(),yield t()}else e=yield fetch(`https://comments.eaimty.com/comments?issue_id=${m}`,{method:"GET"});200===e.status&&(g=g.concat(yield e.json()))}()),u=()=>{g.sort(((e,t)=>new Date(e.created_at).getTime()-new Date(t.created_at).getTime()));let e=document.getElementById("comment-list");e.innerHTML="";var t=document.createElement("div");for(t.id="comment-header",t.innerText="Comments",e.appendChild(t),0===g.length&&((t=document.createElement("div")).id="comment-tip",t.innerText="No comment yet",e.appendChild(t)),t=0;t<g.length;t++){let o=document.createElement("li");var n=document.createElement("div");n.id="comment-info";var i=document.createElement("img");i.id="comment-avatar",i.src=g[t].user.avatar_url,n.appendChild(i),(i=document.createElement("a")).id="comment-author",i.innerText=g[t].user.login,g[t].user.html_url&&(i.href=g[t].user.html_url),n.appendChild(i),(i=document.createElement("div")).id="comment-datetime",i.innerText=new Date(g[t].created_at).toLocaleString(),n.appendChild(i),o.appendChild(n),(n=document.createElement("div")).id="comment-body",n.innerHTML=y(g[t].body),o.appendChild(n),e.appendChild(o)}},v=()=>f(function*(){let e=document.getElementById("comment-action");e.innerHTML="";var n=document.createElement("div");if(n.id="comment-header",n.innerText="Leave a comment",e.appendChild(n),p){if(200===(n=yield fetch(`https://comments.eaimty.com/userinfo?github_access_token=${p}`,{method:"GET"})).status){n=yield n.json();let o=document.createElement("div");o.id="comment-action-info";var i=document.createElement("img");i.id="comment-action-avatar",i.src=n.avatar_url,o.appendChild(i),(i=document.createElement("a")).id="comment-action-author",i.innerText=n.login,i.href=n.html_url,o.appendChild(i);let a=document.createElement("button");a.id="comment-action-logout",a.innerText="Logout",a.addEventListener("click",(()=>{r(),v()})),o.appendChild(a),e.appendChild(o),(n=document.createElement("div")).id="comment-tip",n.innerText="Before commenting, please think about whether your comment is meaningful? Is it related to the topic? Is it rational and friendly? If you were someone else, would you feel uncomfortable seeing this comment?",e.appendChild(n),(n=document.createElement("div")).id="comment-action-input";let c=document.createElement("textarea");c.id="comment-action-textarea",c.placeholder="Leave a comment",n.appendChild(c);let l=document.createElement("button");return l.id="comment-action-post",l.innerText="Comment",l.addEventListener("click",(()=>f(function*(){a.disabled=!0,c.disabled=!0,l.disabled=!0;let e=c.value.trim();0!==e.length&&(201===(yield fetch(`https://comments.eaimty.com/comments?issue_id=${m}&github_access_token=${p}`,{method:"POST",body:JSON.stringify({body:e})})).status?t().then((()=>u())).then((()=>v())):(r(),yield v(),window.alert("Failed to post comment")))}()))),n.appendChild(l),void e.appendChild(n)}r()}(n=document.createElement("div")).id="comment-tip",n.innerText="Clicking the login button means you agree to use cookies to store your GitHub Access Token",e.appendChild(n),(n=document.createElement("button")).id="comment-action-login",n.innerText="Login with GitHub",n.addEventListener("click",(()=>window.location.replace(`https://comments.eaimty.com/login?redirect_uri=${window.location.href}`))),e.appendChild(n)}());t().then((()=>u())).then((()=>v()))</script></div>