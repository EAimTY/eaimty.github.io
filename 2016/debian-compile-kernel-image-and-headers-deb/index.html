<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=#000000 id=color_chrome name=theme-color><meta content=#000000 id=color_safari name=apple-mobile-web-app-status-bar-style><meta content="EAimTY's Blog" name=description><link rel="Shortcut Icon" href=https://www.eaimty.com/favicon.ico><link href=https://www.eaimty.com/favicon.ico rel=Bootmark><link title="EAimTY's Blog" href=https://www.eaimty.com/rss.xml rel=alternate type=application/rss+xml><style>#title,body{line-height:1.6em}body{background:#000;color:#00c000;font-size:1.2em}#container{margin:2.4em auto;width:72%}#header{text-align:center}#header>a{font-size:.96em;margin:auto 1em}#title{font-size:1.6em;font-weight:700;margin:1em auto}#date{font-style:italic}#list>li{margin:.8em auto;list-style:disc}img{max-width:100%}a{color:inherit;text-decoration:none}#content a,a:hover{text-decoration:underline}pre{padding:1em;overflow:auto;background:#1b1d16}:not(pre) >code{padding:.2em;background:#1b1d16;overflow:auto}blockquote{padding:0 1em;margin:0;border-left:.25em solid #212121}@media (max-width:600px){#container{width:88%}#header>a{margin:auto .3em}}</style><title>Debian 下编译 linux-image 与 linux-headers 的 DEB 包 - EAimTY's Blog</title><body><div id=header><a href=https://www.eaimty.com>EAimTY's Blog</a><a href=https://www.eaimty.com/about/>About</a><a href=https://www.eaimty.com/friends/>Friends</a></div><div id=container><a href=https://www.eaimty.com/2016/debian-compile-kernel-image-and-headers-deb/ id=title>Debian 下编译 linux-image 与 linux-headers 的 DEB 包</a><div id=date>2016-06-20</div><div id=content><p><strong>2018年2月2日注：其实升级 Debian 内核的最好方法，就是换用 Debian sid...省去了很多麻烦，况且 sid 在稳定性上也不算差。</strong><p>最近用了几天 win10，结果被恶心到了。具体就不说了，总之就是各种各样的垃圾、各种各样的不和谐。<p>惹不起惹不起，我还是滚回 Linux 吧。<p>重新回到熟悉的 Debian+Gnome 环境，突发奇想准备升级一下内核。于是折腾了半天，把内核升级到了 4.6.2。 或许是 Debian 8 的默认内核太古老（3.x）（CentOS 6 表示不服），也可能是心理作用，感觉 4.x 运行起来的确比 3.x 快了不少，于是手贱直接把旧内核 remove 掉了，而且还加了 purge...(+_+)<p>但没过多长时间，就发现了问题：VirtualBox 无法启动虚拟机...查了一下 log，发现原来是 VirtualBox Kernel Modules 出了问题： VirtualBox Kernel Modules 需要通过 DKMS 使用 linux-headers，而我已经把旧版本的 linux-image 和 linux-headers 都 purge 掉了。然而通过 apt，无论用 testing 源还是 sid(unstable) 源都无法直接安装对应新版本（也就是我装的 4.6.2 版）的 linux-headers 包。<p><del>蛋碎一地...Σ(ﾟДﾟ)</del><p>通过 Google 到的方法，也就是使用 <code>make headers_install</code>，DKMS 仍然报错... 没办法了，重装 Debian...<p>顺便发现了一个制作 Debian 安装 U 盘的好方法方法，只需两条命令即可：<p><code>$ sudo cat debian.iso > /dev/sdb</code><p><code>$ sudo sync</code><p>把这里的 <code>debian.iso</code> 换成安装镜像的名称，保证 <code>/dev/sdb</code> 是你的U盘<p>新系统装好后没多长时间，手贱又发作了，又把 Kernel 升级到了 4.6.2（我真是没救了）。不过这次吸取了上次的教训，折腾了半天，找到一种直接把 Kernel 源码编译成 linux-image 和 linux-headers 的 DEB 包的方法，使 DKMS 可以正常编译 VirtualBox Kernel Modules。<del>这回能好好玩了</del><p>首先安装所需的工具：<p><code>$ sudo apt-get install git fakeroot build-essential ncurses-dev xz-utils libssl-dev bc kernel-package</code><p>需要下载 1GB 左右的文件，耐心等吧。<p>下一步当然是去 <a href=https://kernel.org/>kernel.org</a> 下载内核源码，推荐下载最新的 stable 版，下载 .tar.xz 格式的包即可。 当然，国内连接 kernel.org 的速度不敢恭维，可以到<a href=https://mirrors.ustc.edu.cn/kernel.org/linux/kernel/v4.x/>中科大的源</a>下载。<p>然后解压：<p><code>$ xz -d ***.tar.xz</code><p><code>$ tar -xvf ***.tar</code><p>通过上面的 xz 命令可以把 .tar.xz 解包成常见的 .tar，然后按常规方式解压即可。 之后 cd 进解压后的目录，转到 root 用户 可以按照你的需求改动内核文件。<p>清理一下之前编译的文件：<p><code># make mrproper</code><p>生成 .config 文件：<p><code># make menuconfig</code><p>设置好选项，最后选 save。<p>清理一下：<p><code># make-kpkg clean</code><p>下面开始编译 deb：<p><code># fakeroot make-kpkg --initrd --revision=4.6.2-EAimTY kernel_image kernel_headers -j2</code><p>在这句命令中： <code>--initrd</code> 表示创建 initrd； <code>--revision=4.6.2-EAimTY</code> 中的 <code>4.6.2-EAimTY</code> 是创建的 deb 包的版本号，可以自行修改； <code>kernel_image</code> 表示编译 linux-image; <code>kernel_headers</code> 表示编译 linux-headers，如果不需要可以去掉； <code>-j2</code> 表示使用两个 CPU 核心，具体视 CPU 参数而定，举个栗子：假如你用的 CPU 是最新的 Intel Xeon E5 2699 v4，也就是说有 22 个核心，就把这个参数换成 <code>-j22</code>（不过貌似这个参数最多支持到 <code>-j9</code>...） 想知道你的 CPU 有几个核心，可以使用 <code>$ cat /proc/cpuinfo | grep "cpu cores"</code> 查看<p>经过漫长的等待（我双核 i5，4G 内存的笔记本花了一个多小时），linux-image 和 linux-header 的 deb 包就会出现在上层目录中了。用 <code>dpkg -i</code> 安装。<p>重启后，通过 GRUB 高级选项中就会出现新的内核，进入后，如果有强迫症，可以卸装掉旧的内核：<p><code>$ sudo dpkg -l "linux-image*"</code><p><code>$ sudo dpkg -l "linux-headers*"</code><p>两条命令会分别列出已安装的 linux-image 和 linux-headers，可以用 apt 删掉。<p>通过以上方法安装 linux-image 和 linux-headers 后，VirtualBox 仍然可以完美运行，只需要用 DKMS 重新生成一下 VirtualBox Kernel Modules 即可。</div><div id=comments-issue-id style=display:none>15</div><div id=comments-addition style=display:none>[{"user":{"login":"nrechn","html_url":"https://gyz.io","avatar_url":"https://secure.gravatar.com/avatar/9bcc01c06b1a3ccb58442236364e67c4?d=retro"},"created_at":"2016-07-14T23:32:05Z","body":"内核配置怎么可以默认的就行？#(滑稽)，难怪泥会编译一个多小时呢。而且默认的居然能用起来？？反正我默认的话根本启动不了系统。\n\n表示从来都是自己修改内核配置，刚开始要搞4个小时配置内核，熟悉之后直接沿用原先的config，重新选的时候凭记忆大概10来分钟能几乎把所有选项过一遍。然后双核i5十分钟编译好内核#(滑稽)\n\n另外实际上没必要这么麻烦啦，只要把linux-headers包打开来看看 header files 丢哪儿了，然后把编译内核的临时目录link过去即可，打包什么的多麻烦 #(滑稽)"},{"user":{"login":"frytea","html_url":"https://www.frytea.com","avatar_url":"https://secure.gravatar.com/avatar/efe8762bf0cd029d0a6d24e0faf47adf?d=retro"},"created_at":"2021-11-15T02:46:45Z","body":"`sudo cat debian.iso > /dev/sdb` 这个真是学到了，改日试试"},{"user":{"login":"四斋破乙poi","avatar_url":"https://secure.gravatar.com/avatar/a0b790504103d79d05eda548601ca033?d=retro"},"created_at":"2017-03-18T06:20:06Z","body":"我只是从基佬云音乐过来逛逛的"},{"user":{"login":"EAimTY","html_url":"https://www.eaimty.com/","avatar_url":"https://secure.gravatar.com/avatar/f64037e002ad7b01fe9ee60351bfd1d2?d=retro"},"created_at":"2016-07-15T14:35:18Z","body":"> 内核配置怎么可以默认的就行？#(滑稽)，难怪泥会编译一个多小时呢。而且默认的居然能用起来？？反正我默认的话根本启动不了系统。\n> \n> 表示从来都是自己修改内核配置，刚开始要搞4个小时配置内核，熟悉之后直接沿用原先的config，重新选的时候凭记忆大概10来分钟能几乎把所有选项过一遍。然后双核i5十分钟编译好内核#(滑稽)\n> \n> 另外实际上没必要这么麻烦啦，只要把linux-headers包打开来看看 header files 丢哪儿了，然后把编译内核的临时目录link过去即可，打包什么的多麻烦 #(滑稽)\n\n的确能用，但问题的确很多...😅不过最近以换Arch了，就不存在这种问题了😂另外，我的i5可是睾贵的第一代i5-560M，能流畅运行扫雷😂"}]</div><style>#comment-header,#comment-list>li{margin:1em auto}#comment-avatar,#comment-tip{margin:auto .2em}#comment-action-avatar,#comment-avatar{width:1em;height:1em}#comment-action-info>*,#comment-action-input>*,#comment-info>*{display:inline-block;vertical-align:middle}#comment-header{font-size:1.6em;font-weight:700;line-height:1.6em}#comment-tip{font-style:italic}#comment-list{list-style:none;padding:0}#comment-action-author,#comment-author{font-weight:700;margin:auto .4em}#comment-datetime{font-size:.8em;font-style:italic}#comment-body{margin:auto 1.8em}#comment-action-info>*{margin:1em .2em}#comment-action-input{height:2em;width:100%;margin:1em auto}#comment-action-input>*{height:100%;margin:0 .2em}#comment-action-textarea{width:calc(100% - 8em)}#comment-action-post{width:6em}#comment-action-login{margin:1em .3em}</style><ol id=comment-list></ol><div id=comment-action></div><script>const y=e=>{var t=/\\([\\\|`*_{}\[\]()#+\-~])/g,n=/\n *&gt; *([^]*?)(?=(\n|$){2})/g,i=/\n( *)(?:[*\-+]|((\d+)|([a-z])|[A-Z])[.)]) +([^]*?)(?=(\n|$){2})/g,o=/(^|[^A-Za-z\d\\])(([*_])|(~)|(\^)|(--)|(\+\+)|`)(\2?)([^<]*?)\2\8(?!\2)(?=\W|_|$)/g,a=/^.*\n( *\|( *:?-+:?-+:? *\|)* *\n|)/,c=/.*\n/g,m=/\||(.*?[^\\])\|/g;const l=(t,n)=>{e=e.replace(t,n)},d=(e,t)=>"<"+e+">"+t+"</"+e+">",r=e=>e.replace(n,((e,t)=>d("blockquote",r(u(t.replace(/^ *&gt; */gm,"")))))),s=e=>e.replace(i,((e,t,n,i,o,a)=>(e=d("li",u(a.split(RegExp("\n ?"+t+"(?:(?:\\d+|[a-zA-Z])[.)]|[*\\-+]) +","g")).map(s).join("</li><li>"))),"\n"+(n?'<ol start="'+(i?n+'">':parseInt(n,36)-9+'" style="list-style-type:'+(o?"low":"upp")+'er-alpha">')+e+"</ol>":d("ul",e))))),u=e=>e.replace(o,((e,t,n,i,o,a,c,m,l,r)=>t+d(i?l?"strong":"em":o?l?"s":"sub":a?"sup":c?"small":m?"big":"code",u(r))));var p=[],h=0;return e="\n"+e+"\n",l(/</g,"&lt;"),l(/>/g,"&gt;"),l(/\t|\r|\uf8ff/g,"  "),e=r(e),l(/^([*\-=_] *){3,}$/gm,"<hr/>"),e=s(e),l(/<\/(ol|ul)>\n\n<\1>/g,""),l(/\n((```|~~~).*\n?([^]*?)\n?\2|((    .*?\n)+))/g,((e,t,n,i,o)=>(p[--h]=d("pre",d("code",i||o.replace(/^    /gm,""))),h+""))),l(/((!?)\[(.*?)\]\((.*?)( ".*")?\)|\\([\\`*_{}\[\]()#+\-.!~]))/g,((e,n,i,o,a,c,m)=>(p[--h]=a?i?'<img src="'+a+'" alt="'+o+'"/>':'<a href="'+a+'">'+u(o).replace(t,"$1")+"</a>":m,h+""))),l(/&lt;(.*?)&gt;/g,((e,n)=>'<a href="'+n+'">'+u(n).replace(t,"$1")+"</a>")),l(/\n(( *\|.*?\| *\n)+)/g,((e,n)=>{var i=n.match(a)[1];return"\n"+d("table",n.replace(c,((e,n)=>e==i?"":d("tr",e.replace(m,((e,o,a)=>a?d(i&&!n?"th":"td",u(o||"").replace(t,"$1")):""))))))})),l(/(?=^|>|\n)([>\s]*?)(#{1,6}) (.*?)( #*)? *(?=\n|$)/g,((e,n,i,o)=>n+d("h"+i.length,u(o).replace(t,"$1")))),l(/(?=^|>|\n)\s*\n+([^<]+?)\n+\s*(?=\n|<|$)/g,((e,n)=>d("p",u(n).replace(t,"$1")))),l(/-\d+\uf8ff/g,(e=>p[parseInt(e,10)])),e.trim()},f=e=>{let t=t=>e.next(t),n=t=>e.throw(t);return new Promise(((i,o)=>{let a=e=>{e.done?i(e.value):Promise.resolve(e.value).then(t,n).then(a,o)};a(e.next())}))};let g;const m=document.getElementById("comments-issue-id").innerText,n=new URL(window.location.href);let q,p=n.searchParams.get("github_access_token");p&&(document.cookie=`github_access_token=${p};Path=/;Secure;SameSite=Strict`,n.searchParams.delete("github_access_token"),window.location.replace(n)),null!=p||(p=null==(q=document.cookie.split(";").find((e=>e.trim().startsWith("github_access_token="))))?void 0:q.trim().substring(20));const r=()=>{document.cookie="github_access_token=;expires=Thu, 01 Jan 1970 00:00:00 GMT;Path=/;Secure;SameSite=Strict",p=null},t=()=>f(function*(){var e;let n;if(g=JSON.parse(null!=(n=null==(e=document.getElementById("comments-addition"))?void 0:e.innerText)?n:"[]"),p){if(200!==(e=yield fetch(`https://comments.eaimty.com/comments?issue_id=${m}&github_access_token=${p}`,{method:"GET"})).status)return r(),yield t()}else e=yield fetch(`https://comments.eaimty.com/comments?issue_id=${m}`,{method:"GET"});200===e.status&&(g=g.concat(yield e.json()))}()),u=()=>{g.sort(((e,t)=>new Date(e.created_at).getTime()-new Date(t.created_at).getTime()));let e=document.getElementById("comment-list");e.innerHTML="";var t=document.createElement("div");for(t.id="comment-header",t.innerText="Comments",e.appendChild(t),0===g.length&&((t=document.createElement("div")).id="comment-tip",t.innerText="No comment yet",e.appendChild(t)),t=0;t<g.length;t++){let o=document.createElement("li");var n=document.createElement("div");n.id="comment-info";var i=document.createElement("img");i.id="comment-avatar",i.src=g[t].user.avatar_url,n.appendChild(i),(i=document.createElement("a")).id="comment-author",i.innerText=g[t].user.login,g[t].user.html_url&&(i.href=g[t].user.html_url),n.appendChild(i),(i=document.createElement("div")).id="comment-datetime",i.innerText=new Date(g[t].created_at).toLocaleString(),n.appendChild(i),o.appendChild(n),(n=document.createElement("div")).id="comment-body",n.innerHTML=y(g[t].body),o.appendChild(n),e.appendChild(o)}},v=()=>f(function*(){let e=document.getElementById("comment-action");e.innerHTML="";var n=document.createElement("div");if(n.id="comment-header",n.innerText="Leave a comment",e.appendChild(n),p){if(200===(n=yield fetch(`https://comments.eaimty.com/userinfo?github_access_token=${p}`,{method:"GET"})).status){n=yield n.json();let o=document.createElement("div");o.id="comment-action-info";var i=document.createElement("img");i.id="comment-action-avatar",i.src=n.avatar_url,o.appendChild(i),(i=document.createElement("a")).id="comment-action-author",i.innerText=n.login,i.href=n.html_url,o.appendChild(i);let a=document.createElement("button");a.id="comment-action-logout",a.innerText="Logout",a.addEventListener("click",(()=>{r(),v()})),o.appendChild(a),e.appendChild(o),(n=document.createElement("div")).id="comment-tip",n.innerText="Before commenting, please think about whether your comment is meaningful? Is it related to the topic? Is it rational and friendly? If you were someone else, would you feel uncomfortable seeing this comment?",e.appendChild(n),(n=document.createElement("div")).id="comment-action-input";let c=document.createElement("textarea");c.id="comment-action-textarea",c.placeholder="Leave a comment",n.appendChild(c);let l=document.createElement("button");return l.id="comment-action-post",l.innerText="Comment",l.addEventListener("click",(()=>f(function*(){a.disabled=!0,c.disabled=!0,l.disabled=!0;let e=c.value.trim();0!==e.length&&(201===(yield fetch(`https://comments.eaimty.com/comments?issue_id=${m}&github_access_token=${p}`,{method:"POST",body:JSON.stringify({body:e})})).status?t().then((()=>u())).then((()=>v())):(r(),yield v(),window.alert("Failed to post comment")))}()))),n.appendChild(l),void e.appendChild(n)}r()}(n=document.createElement("div")).id="comment-tip",n.innerText="Clicking the login button means you agree to use cookies to store your GitHub Access Token",e.appendChild(n),(n=document.createElement("button")).id="comment-action-login",n.innerText="Login with GitHub",n.addEventListener("click",(()=>window.location.replace(`https://comments.eaimty.com/login?redirect_uri=${window.location.href}`))),e.appendChild(n)}());t().then((()=>u())).then((()=>v()))</script></div>