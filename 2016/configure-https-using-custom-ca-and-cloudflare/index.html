<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=#000000 id=color_chrome name=theme-color><meta content=#000000 id=color_safari name=apple-mobile-web-app-status-bar-style><meta content="EAimTY's Blog" name=description><link rel="Shortcut Icon" href=https://www.eaimty.com/favicon.ico><link href=https://www.eaimty.com/favicon.ico rel=Bootmark><link title="EAimTY's Blog" href=https://www.eaimty.com/rss.xml rel=alternate type=application/rss+xml><style>#title,body{line-height:1.6em}body{background:#000;color:#00c000;font-size:1.2em}#container{margin:2.4em auto;width:72%}#header{text-align:center}#header>a{font-size:.96em;margin:auto 1em}#title{font-size:1.6em;font-weight:700;margin:1em auto}#date{font-style:italic}#list>li{margin:.8em auto;list-style:disc}img{max-width:100%}a{color:inherit;text-decoration:none}#content a,a:hover{text-decoration:underline}pre{padding:1em;overflow:auto;background:#1b1d16}:not(pre) >code{padding:.2em;background:#1b1d16;overflow:auto}blockquote{padding:0 1em;margin:0;border-left:.25em solid #212121}@media (max-width:600px){#container{width:88%}#header>a{margin:auto .3em}}</style><title>用自签名 SSL 证书配合 CloudFlare 免费 SSL 构建全站 HTTPS - EAimTY's Blog</title><body><div id=header><a href=https://www.eaimty.com>EAimTY's Blog</a><a href=https://www.eaimty.com/about/>About</a><a href=https://www.eaimty.com/friends/>Friends</a></div><div id=container><a href=https://www.eaimty.com/2016/configure-https-using-custom-ca-and-cloudflare/ id=title>用自签名 SSL 证书配合 CloudFlare 免费 SSL 构建全站 HTTPS</a><div id=date>2016-10-23</div><div id=content><p>之前一段时间，本博客一直在用 letsencrypt 的 SSL 证书。这个证书的优点是免费，然而缺点也很明显，就是使用起来比较麻烦，而且有效期只有 3 个月。 我是个懒人，所以能一劳永逸的事，我都会一次性做完。很早之前就了解到 CloudFlare 有免费的 SSL 证书，但是假如仅在 CloudFlare 后台中开启它的话，并不能做到全站加密，只能开启 Flexible 模式，而不是 Full 模式。<p>进入 CloudFlare 后台->Crypto，可以看到第一项就是免费提供的 SSL。 这里有4种模式可选：Off（关闭 SSL）、Flexible（视情况而定）、Full（全部加密，需要在服务器上部署证书，但 CloudFlare 不会检查证书的有效性）、Full(Strict)（严格模式，也就是全部加密，而且 CloudFlare 会检查服务器上的证书是否有效）。 在这里，我们的目标是开启 Full 模式，实现方式是：首先自签一个泛域名的证书，然后在 Nginx 中设置通过 HTTPS 访问网站，最后到 CloudFlare 中设置 SSL 模式。 当然，如果你想要开启 Full(Strict) 模式，也是可以的，但服务器上就不能部署自签名的证书了，而需要一个有效机构颁发的证书，例如 letsencrypt 的证书，然而怎么做的缺点就是需要定期续期。<p>使用自签名证书就不存在这个问题了，你想签多长时间的有效期就可以签多长时间~~（我签了 20 年，2333333）~~，更换服务器时，也仅需要把证书文件拷到新服务器上。<h1 id=zhun-bei-gong-zuo>准备工作</h1><p>第一步，当然是确保你的 DNS 是 CloudFlare 的！<p>第二步，安装 OpenSSL<p>debian 系：<p><code># apt-get install openssl</code><p>rhel 系：<p><code># yum install openssl</code><h1 id=qian-fa-zi-qian-ming-zheng-shu>签发自签名证书</h1><p>首先建立一个生成、存放证书的目录：<p><code># mkdir certificate</code><p>进入该目录，然后签发一个根域名的 CA 证书，第一步创建一个私钥 <code>ca.key</code>：<p><code># openssl genrsa -des3 -out ca.key 2048</code><p>第二步，生成 CA 根证书（公钥）：<p><code># openssl req -new -x509 -days 7305 -key ca.key -out ca.crt</code><p>命令中，<code>-days</code> 后面的 <code>7305</code> 是指证书的有效期，以天为单位，这里设置成了 20 年，手动滑稽。<p>执行命令后会让你填一堆地区、组织什么的东西，随便填就好，但注意期间会让你填写 <code>common name</code>，也就是域名，这里填入的是你的根域名，例如 <code>eaimty.com</code>。最后，你就得到了一个根域的 CA 证书。<p>之后生成一个给泛域名用的私钥：<p><code># openssl genrsa -des3 -out yourdomain.com.pem 1024</code><p>解密私钥：<p><code># openssl rsa -in yourdomain.com.pem -out yourdomain.com.key</code><p>生成签名请求：<p><code># openssl req -new -key yourdomain.com.pem -out yourdomain.com.csr</code><p>这一步中 <code>common name</code> 要填入泛域名，如 <code>*.eaimty.com</code>，这样生成的证书可以供所有子域使用。<p>下一步还不能直接执行签名，否则会报错，要先修改一下 openssl 的配置文件：<p><code># vi /etc/pki/tls/openssl.cnf</code><p>找到其中的 <code>dir = </code>，把值改成 <code>./ca</code>。<p>然后在你签发证书的工作目录中：<p><code># mkdir -p ca/newcerts</code><p><code># touch ca/index.txt</code><p><code># touch ca/serial</code><p><code># echo "01" > ca/serial</code><p>这样就可以正常执行签名了：<p><code># openssl ca -policy policy_anything -days 7305 -cert ca.crt -keyfile ca.key -in yourdomain.com.csr -out yourdomain.com.crt</code><p>这一步中的参数和上一步中的意义相同。 最后你会得到一个 <code>yourdomain.com.crt</code> 文件，把 <code>ca.crt</code> 中的内容粘贴到 <code>yourdomain.com.crt</code> 的最后，证书就签发完成了。<p>准备好 <code>yourdomain.com.crt</code>（网站证书）和 <code>yourdomain.com.key</code>（网站私钥），开始配置 Nginx！<h1 id=pei-zhi-nginx>配置 Nginx</h1><p>这一步很简单，找到你的网站（所签发泛域名的所有子域名都可以用）的 Nginx 配置文件（通常是 <code>/etc/nginx/conf.d/</code> 下的 XXX.conf）<p>修改 <code>server{}</code> 段 <code>listen 443 ssl</code>，并在其下添加：<pre class=language-conf data-lang=conf><code class=language-conf data-lang=conf>ssl_certificate /path/to/yourdomain.com.crt;
ssl_certificate_key /path/to/yourdomain.com.key;
</code></pre><p>测试 Nginx 的配置文件是否有错：<p><code># nginx -t</code><p>注意看是否报错。<p>没有问题的话，重启 Nginx。<h1 id=she-zhi-cloudflare>设置 CloudFlare</h1><h2 id=kai-qi-cloudflare-ssl>开启 CloudFlare SSL</h2><p>进入 CloudFlare 管理界面，将 Crypto->SSL 改为“Full”。<p>现在通过浏览器进入 <code>https://你的网站/</code>，你就会发现小绿锁出现了！就说明我们成功了！<h2 id=she-zhi-http-qing-qiu-de-zhong-ding-xiang>设置 HTTP 请求的重定向</h2><p>虽然小绿锁出现了，但是假如访客直接输入没有声明协议的网址访问网站，默认走的仍是没有 SSL 保护的 HTTP。<p>我们可以通过 Nginx 来设置，也可以通过 CloudFlare 来设置。我的所有子域名都开启了 SSL，所以我是用 CloudFlare 设置的，更方便。<p>进入 CloudFlare 后台中的 Page Rules 选项卡，新建如下规则：<p><img alt src=/pictures/vRlUMux1IT62qYr.png><p>这样就可以一次性为所有子域设置重定向了。<p>然后记得关闭服务器上的 80 端口，以使强制通过 HTTP 协议时无法访问网站。<p>想要更加安全的话，CloudFlare 的后台中也有 HSTS 的设置，配置好后去 <a href=https://hstspreload.org>https://hstspreload.org</a> 提交你的域名，就完成全站 HSTS 啦！</div><div id=comments-issue-id style=display:none>17</div><div id=comments-addition style=display:none>[{"user":{"login":"EAimTY","html_url":"https://www.eaimty.com/","avatar_url":"https://secure.gravatar.com/avatar/f64037e002ad7b01fe9ee60351bfd1d2?d=retro"},"created_at":"2017-08-27T20:43:18Z","body":"> 您好!博主，看了你的文章，决定按照您的方法一步一步执行，但是到了这一步不太理解了，麻烦指导一下，万分感谢！\n> 然后在你签发证书的工作目录中：\n> \n> `# mkdir -p ca/newcerts`\n> \n> `# touch ca/index.txt`\n> \n> `# touch ca/serial`\n> \n> `# echo \"01\" > ca/serial`\n> \n> 这里的目录指的是certificate 这个目录么？还是直接在root 目录执行以上代码？\n\n抱歉文章中有一处没有说清楚...建立certificate目录后"},{"user":{"login":"Michael翔","html_url":"https://michaelxoxo.github.io/","avatar_url":"https://secure.gravatar.com/avatar/ac8f4a8e0833adc4f1aa7ff6e3802c53?d=retro"},"created_at":"2023-03-28T15:35:23Z","body":"博主，我是通过 acme 安装的免费证书在 NAS 上的，通过在 NAS 上的反向代理设置，https://我的域名:端口 A，是可以正常访问服务了，但是我 NAS 上其他的服务，我现在通过http://域名:端口 B访问，它会自动给我改写为 https://域名:端口 B，这是为什么呢？希望能解惑"},{"user":{"login":"wang","html_url":"https://www.wchb7.com/","avatar_url":"https://secure.gravatar.com/avatar/e40dec05817892eb6361ea9939bc5508?d=retro"},"created_at":"2018-05-19T14:38:02Z","body":"eaimty.com 怎么实现的 自动跳转 到 www.eaimty.com?"},{"user":{"login":"EAimTY","html_url":"https://www.eaimty.com/","avatar_url":"https://secure.gravatar.com/avatar/f64037e002ad7b01fe9ee60351bfd1d2?d=retro"},"created_at":"2018-05-21T14:29:37Z","body":"> eaimty.com 怎么实现的 自动跳转 到 www.eaimty.com?\n\n我用的是Cloudflare里的Page Rules，按照hsts标准先把`http://*eaimty.com/*`301到`https://$1eaimty.com/$2`，然后把`https://eaimty.com/*`301到`https://www.eaimty.com/$1`\n用Nginx也可以很方便地做跳转，网上有很多教程的"},{"user":{"login":"xuefeng","avatar_url":"https://secure.gravatar.com/avatar/fbad5fab2c900453de6b4d233b41d5a6?d=retro"},"created_at":"2017-08-30T03:08:16Z","body":"> > 您好!博主，看了你的文章，决定按照您的方法一步一步执行，但是到了这一步不太理解了，麻烦指导一下，万分感谢！\n> > 然后在你签发证书的工作目录中：\n> > \n> > `# mkdir -p ca/newcerts`\n> > \n> > `# touch ca/index.txt`\n> > \n> > `# touch ca/serial`\n> > \n> > `# echo \"01\" > ca/serial`\n> > \n> > 这里的目录指的是certificate 这个目录么？还是直接在root 目录执行以上代码？\n> \n> 抱歉文章中有一处没有说清楚...建立certificate目录后\n\n好的，感谢您的回复，我试试，就是说mkdir certificate 后 要cd 到 certificate 路径后再执行例如下面的语句对吧？\n\n然后签发一个根域名的CA证书，第一步创建一个私钥ca.key：\n\n`# openssl genrsa -des3 -out ca.key 2048`"},{"user":{"login":"Simona","avatar_url":"https://secure.gravatar.com/avatar/b7eefb5e179445889ddb58d908a7d584?d=retro"},"created_at":"2023-05-16T07:53:39Z","body":"请教下检查 nginx ， 出现 nginx: [emerg] cannot load certificate \"/root/certificate/domain.com.csr\": PEM_read_bio_X509_AUX() failed (SSL: error:0480006C:PEM routines::no start line:Expecting: TRUSTED CERTIFICATE) 是怎么回事呢？"},{"user":{"login":"gavincook","avatar_url":"https://secure.gravatar.com/avatar/4f41d8f36dbc40ab75af3d8527e48e00?d=retro"},"created_at":"2023-05-16T02:30:16Z","body":"可以直接将CloudFlare的SSL/TLS模式调整为：Flexible，然后自己的服务可以基于以http的方式提供，用户以https的方式访问"},{"user":{"login":"xuefeng","avatar_url":"https://secure.gravatar.com/avatar/fbad5fab2c900453de6b4d233b41d5a6?d=retro"},"created_at":"2017-08-27T14:39:50Z","body":"您好!博主，看了你的文章，决定按照您的方法一步一步执行，但是到了这一步不太理解了，麻烦指导一下，万分感谢！\n然后在你签发证书的工作目录中：\n\n`# mkdir -p ca/newcerts`\n\n`# touch ca/index.txt`\n\n`# touch ca/serial`\n\n`# echo \"01\" > ca/serial`\n\n这里的目录指的是certificate 这个目录么？还是直接在root 目录执行以上代码？"}]</div><style>#comment-header,#comment-list>li{margin:1em auto}#comment-avatar,#comment-tip{margin:auto .2em}#comment-action-avatar,#comment-avatar{width:1em;height:1em}#comment-action-info>*,#comment-action-input>*,#comment-info>*{display:inline-block;vertical-align:middle}#comment-header{font-size:1.6em;font-weight:700;line-height:1.6em}#comment-tip{font-style:italic}#comment-list{list-style:none;padding:0}#comment-action-author,#comment-author{font-weight:700;margin:auto .4em}#comment-datetime{font-size:.8em;font-style:italic}#comment-body{margin:auto 1.8em}#comment-action-info>*{margin:1em .2em}#comment-action-input{height:2em;width:100%;margin:1em auto}#comment-action-input>*{height:100%;margin:0 .2em}#comment-action-textarea{width:calc(100% - 8em)}#comment-action-post{width:6em}#comment-action-login{margin:1em .3em}</style><ol id=comment-list></ol><div id=comment-action></div><script>const y=e=>{var t=/\\([\\\|`*_{}\[\]()#+\-~])/g,n=/\n *&gt; *([^]*?)(?=(\n|$){2})/g,i=/\n( *)(?:[*\-+]|((\d+)|([a-z])|[A-Z])[.)]) +([^]*?)(?=(\n|$){2})/g,o=/(^|[^A-Za-z\d\\])(([*_])|(~)|(\^)|(--)|(\+\+)|`)(\2?)([^<]*?)\2\8(?!\2)(?=\W|_|$)/g,a=/^.*\n( *\|( *:?-+:?-+:? *\|)* *\n|)/,c=/.*\n/g,m=/\||(.*?[^\\])\|/g;const l=(t,n)=>{e=e.replace(t,n)},d=(e,t)=>"<"+e+">"+t+"</"+e+">",r=e=>e.replace(n,((e,t)=>d("blockquote",r(u(t.replace(/^ *&gt; */gm,"")))))),s=e=>e.replace(i,((e,t,n,i,o,a)=>(e=d("li",u(a.split(RegExp("\n ?"+t+"(?:(?:\\d+|[a-zA-Z])[.)]|[*\\-+]) +","g")).map(s).join("</li><li>"))),"\n"+(n?'<ol start="'+(i?n+'">':parseInt(n,36)-9+'" style="list-style-type:'+(o?"low":"upp")+'er-alpha">')+e+"</ol>":d("ul",e))))),u=e=>e.replace(o,((e,t,n,i,o,a,c,m,l,r)=>t+d(i?l?"strong":"em":o?l?"s":"sub":a?"sup":c?"small":m?"big":"code",u(r))));var p=[],h=0;return e="\n"+e+"\n",l(/</g,"&lt;"),l(/>/g,"&gt;"),l(/\t|\r|\uf8ff/g,"  "),e=r(e),l(/^([*\-=_] *){3,}$/gm,"<hr/>"),e=s(e),l(/<\/(ol|ul)>\n\n<\1>/g,""),l(/\n((```|~~~).*\n?([^]*?)\n?\2|((    .*?\n)+))/g,((e,t,n,i,o)=>(p[--h]=d("pre",d("code",i||o.replace(/^    /gm,""))),h+""))),l(/((!?)\[(.*?)\]\((.*?)( ".*")?\)|\\([\\`*_{}\[\]()#+\-.!~]))/g,((e,n,i,o,a,c,m)=>(p[--h]=a?i?'<img src="'+a+'" alt="'+o+'"/>':'<a href="'+a+'">'+u(o).replace(t,"$1")+"</a>":m,h+""))),l(/&lt;(.*?)&gt;/g,((e,n)=>'<a href="'+n+'">'+u(n).replace(t,"$1")+"</a>")),l(/\n(( *\|.*?\| *\n)+)/g,((e,n)=>{var i=n.match(a)[1];return"\n"+d("table",n.replace(c,((e,n)=>e==i?"":d("tr",e.replace(m,((e,o,a)=>a?d(i&&!n?"th":"td",u(o||"").replace(t,"$1")):""))))))})),l(/(?=^|>|\n)([>\s]*?)(#{1,6}) (.*?)( #*)? *(?=\n|$)/g,((e,n,i,o)=>n+d("h"+i.length,u(o).replace(t,"$1")))),l(/(?=^|>|\n)\s*\n+([^<]+?)\n+\s*(?=\n|<|$)/g,((e,n)=>d("p",u(n).replace(t,"$1")))),l(/-\d+\uf8ff/g,(e=>p[parseInt(e,10)])),e.trim()},f=e=>{let t=t=>e.next(t),n=t=>e.throw(t);return new Promise(((i,o)=>{let a=e=>{e.done?i(e.value):Promise.resolve(e.value).then(t,n).then(a,o)};a(e.next())}))};let g;const m=document.getElementById("comments-issue-id").innerText,n=new URL(window.location.href);let q,p=n.searchParams.get("github_access_token");p&&(document.cookie=`github_access_token=${p};Path=/;Secure;SameSite=Strict`,n.searchParams.delete("github_access_token"),window.location.replace(n)),null!=p||(p=null==(q=document.cookie.split(";").find((e=>e.trim().startsWith("github_access_token="))))?void 0:q.trim().substring(20));const r=()=>{document.cookie="github_access_token=;expires=Thu, 01 Jan 1970 00:00:00 GMT;Path=/;Secure;SameSite=Strict",p=null},t=()=>f(function*(){var e;let n;if(g=JSON.parse(null!=(n=null==(e=document.getElementById("comments-addition"))?void 0:e.innerText)?n:"[]"),p){if(200!==(e=yield fetch(`https://comments.eaimty.com/comments?issue_id=${m}&github_access_token=${p}`,{method:"GET"})).status)return r(),yield t()}else e=yield fetch(`https://comments.eaimty.com/comments?issue_id=${m}`,{method:"GET"});200===e.status&&(g=g.concat(yield e.json()))}()),u=()=>{g.sort(((e,t)=>new Date(e.created_at).getTime()-new Date(t.created_at).getTime()));let e=document.getElementById("comment-list");e.innerHTML="";var t=document.createElement("div");for(t.id="comment-header",t.innerText="Comments",e.appendChild(t),0===g.length&&((t=document.createElement("div")).id="comment-tip",t.innerText="No comment yet",e.appendChild(t)),t=0;t<g.length;t++){let o=document.createElement("li");var n=document.createElement("div");n.id="comment-info";var i=document.createElement("img");i.id="comment-avatar",i.src=g[t].user.avatar_url,n.appendChild(i),(i=document.createElement("a")).id="comment-author",i.innerText=g[t].user.login,g[t].user.html_url&&(i.href=g[t].user.html_url),n.appendChild(i),(i=document.createElement("div")).id="comment-datetime",i.innerText=new Date(g[t].created_at).toLocaleString(),n.appendChild(i),o.appendChild(n),(n=document.createElement("div")).id="comment-body",n.innerHTML=y(g[t].body),o.appendChild(n),e.appendChild(o)}},v=()=>f(function*(){let e=document.getElementById("comment-action");e.innerHTML="";var n=document.createElement("div");if(n.id="comment-header",n.innerText="Leave a comment",e.appendChild(n),p){if(200===(n=yield fetch(`https://comments.eaimty.com/userinfo?github_access_token=${p}`,{method:"GET"})).status){n=yield n.json();let o=document.createElement("div");o.id="comment-action-info";var i=document.createElement("img");i.id="comment-action-avatar",i.src=n.avatar_url,o.appendChild(i),(i=document.createElement("a")).id="comment-action-author",i.innerText=n.login,i.href=n.html_url,o.appendChild(i);let a=document.createElement("button");a.id="comment-action-logout",a.innerText="Logout",a.addEventListener("click",(()=>{r(),v()})),o.appendChild(a),e.appendChild(o),(n=document.createElement("div")).id="comment-tip",n.innerText="Before commenting, please think about whether your comment is meaningful? Is it related to the topic? Is it rational and friendly? If you were someone else, would you feel uncomfortable seeing this comment?",e.appendChild(n),(n=document.createElement("div")).id="comment-action-input";let c=document.createElement("textarea");c.id="comment-action-textarea",c.placeholder="Leave a comment",n.appendChild(c);let l=document.createElement("button");return l.id="comment-action-post",l.innerText="Comment",l.addEventListener("click",(()=>f(function*(){a.disabled=!0,c.disabled=!0,l.disabled=!0;let e=c.value.trim();0!==e.length&&(201===(yield fetch(`https://comments.eaimty.com/comments?issue_id=${m}&github_access_token=${p}`,{method:"POST",body:JSON.stringify({body:e})})).status?t().then((()=>u())).then((()=>v())):(r(),yield v(),window.alert("Failed to post comment")))}()))),n.appendChild(l),void e.appendChild(n)}r()}(n=document.createElement("div")).id="comment-tip",n.innerText="Clicking the login button means you agree to use cookies to store your GitHub Access Token",e.appendChild(n),(n=document.createElement("button")).id="comment-action-login",n.innerText="Login with GitHub",n.addEventListener("click",(()=>window.location.replace(`https://comments.eaimty.com/login?redirect_uri=${window.location.href}`))),e.appendChild(n)}());t().then((()=>u())).then((()=>v()))</script></div>