<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=#000000 id=color_chrome name=theme-color><meta content=#000000 id=color_safari name=apple-mobile-web-app-status-bar-style><meta content="EAimTY's Blog" name=description><link rel="Shortcut Icon" href=https://www.eaimty.com/favicon.ico><link href=https://www.eaimty.com/favicon.ico rel=Bootmark><link title="EAimTY's Blog" href=https://www.eaimty.com/rss.xml rel=alternate type=application/rss+xml><style>#title,body{line-height:1.6em}body{background:#000;color:#00c000;font-size:1.2em}#container{margin:2.4em auto;width:72%}#header{text-align:center}#header>a{font-size:.96em;margin:auto 1em}#title{font-size:1.6em;font-weight:700;margin:1em auto}#date{font-style:italic}#list>li{margin:.8em auto;list-style:disc}img{max-width:100%}a{color:inherit;text-decoration:none}#content a,a:hover{text-decoration:underline}pre{padding:1em;overflow:auto;background:#1b1d16}:not(pre) >code{padding:.2em;background:#1b1d16;overflow:auto}blockquote{padding:0 1em;margin:0;border-left:.25em solid #212121}@media (max-width:600px){#container{width:88%}#header>a{margin:auto .3em}}</style><title>将 git 仓库作为数据库的动态 CMS：hummingbird - EAimTY's Blog</title><body><div id=header><a href=https://www.eaimty.com>EAimTY's Blog</a><a href=https://www.eaimty.com/about/>About</a><a href=https://www.eaimty.com/friends/>Friends</a></div><div id=container><a href=https://www.eaimty.com/2021/hummingbird/ id=title>将 git 仓库作为数据库的动态 CMS：hummingbird</a><div id=date>2021-12-20</div><div id=content><p>我从今年六月开始学 Rust，到现在差不多有半年了。写 <a href=https://github.com/EAimTY/hummingbird>hummingbird</a> 这个项目的想法我在八月就已经有了：写一个用 git 仓库作为数据库的内容管理系统，给 git repo 中 markdown 格式的文章套 HTML 模板，然后 serve。 这样能结合传统 CMS 和 GitHub Pages 的优点——能用对于 CMS 本身只读的 git 仓库保证数据的安全性，也能像传统的 CMS 一样提供动态内容，比如搜索文章内容，甚至支持在一次搜索中使用多个 filter 来缩小范围，还不必像（免费版） GitHub Pages 一样只能建在公开仓库上。GitHub 的仓库文件编辑器还可以直接视为管理后台。 当然这种实现也会导致一些限制，例如不能原生支持评论，能实现的功能比较少，数据库更新不能太频繁，比起 GitHub Pages 需要一台服务器来跑服务端... hummingbird 比 WordPress 大概会快十倍吧，大概（<p>总之我觉得这个项目应该有适合的使用场景，所以就开始动手了。经过断断续续 4 个月的开发，终于把雏形写出来了。<p>写 hummingbird 的过程基本上就是我入门 Rust 的过程。每过一段时间，回头看之前写的代码就会觉得写得稀烂，想重构。这个项目的数据库实现我重写过不下五次，然而现在还是觉得写得很差。这也算是学习的过程吧。<p>不论从代码上看，还是从软件工程角度看 hummingbird，都有些问题——某些功能实现地很幼稚，抽象也到处漏，但我总算是写完了一个比较复杂的项目，比起之前总是纸上谈兵还是有进步的。<p>说说大体的实现思路吧：<p>整个项目主要分成 3 个部分：配置、数据库和服务器 / 路由。<p>配置部分很简单，就是读一个 TOML 格式的配置文件然后解析数据，没什么好说的。<p>数据库部分大概又能分 3 个部分吧：内存里的数据库存储部分，集成的 git 客户端，还有模板系统。 存储的实现比较原始，就是在解析过 git 仓库之后把其中的所有内容存进二叉堆排序，然后转成 Vec。另外还有些关于内容作者之类的映射。 git 部分是用 <a href=https://libgit2.org/>libgit2</a> 实现的，用了 <a href=https://github.com/rust-lang/git2-rs>git2-rs</a> 这个 Rust 的 bindings。这里算是写项目前期坑最多的地方，libgit2 暴露的 API 层级比较低，不像平时直接用 git 命令一样方便，而且当时还不太熟悉 Rust，实现反向遍历 commits 拿到文章作者、创建时间和更改时间花了很大力气。另外，git2-rs 的仓库抽象是 <code>!Send</code> 和 <code>!Sync</code> 的，所以刚开始写数据库时我只能做一个 <code>RepoGuard</code> 包住 git 仓库把它留在主线程用 Channel 通信，把剩下的部分 spawn 成 tasks 出去，从 git 仓库取数据的过程又臭又长。后面我发现 libgit2 的文档中只提到不能 parallel 地使用仓库，所以才会 <code>!Send</code> 和 <code>!Sync</code>。hummingbird 只有在被手动触发数据更新的时候才会操作 git 仓库，而且操作会上排他锁，所以直接把仓库标成 <code>Sync</code> 作为数据库成员走状态共享肯定没问题。 模板系统中的 markdown 解析用了 <a href=https://github.com/raphlinus/pulldown-cmark>pulldown-cmark</a>，HTML 模板应用是自己手写的，因为 <a href=https://github.com/Keats/tera>tera</a> 这类的模板实现实在是太重了。说实话我不是很满意现在的实现，有一大堆 clone。之后我想写一个完全 Evaluate-on-Write 的、带 Cacher 的 StringBuilder。<p>服务器 / 路由部分我也改过很多次。最早是用 <a href=https://github.com/tokio-rs/axum>axum</a> 写的，但后来发现 axum 的很多功能我完全用不到，比如 middleware 之类的，而且 axum 有大约四百个依赖，太重了。所以我换到了 <a href=https://github.com/hyperium/hyper>hyper</a>，不过就要自己解决路由的问题了。开始时我想用一张大的字典当路由表，在更新数据库的时候就把所有所有数据解析好，但是发现存储效率不是很高，改成存过程也比较难实现。最后我的解决方案是用一张字典存文章、页面和的其它的静态路径，其它有参数的路径用字典树匹配和捕获。我写了一个泛型的字典树实现，但是 bench 后发现效率比 <a href=https://github.com/ibraheemdev/matchit>matchit</a> 低至少一倍，<del>我还是太年轻</del>，所以就用了 matchit。<p>hummingbird 有什么适用的具体使用场景吗？我觉得可能用来 serve 长篇的文档、说明比较好（类似于 <a href=https://llvm.org/docs/LangRef.html>LLVM IR</a> 这种），用来做一个简单的博客也不错，只是需要外挂评论系统。</div><div id=comments-issue-id style=display:none>49</div><div id=comments-addition style=display:none>[{"user":{"login":"凡尘","avatar_url":"https://secure.gravatar.com/avatar/60704096935c4f6f73bd6c7c862c4c2b?d=retro"},"created_at":"2022-01-20T07:34:27Z","body":"顶一下作者"},{"user":{"login":"ortt","avatar_url":"https://secure.gravatar.com/avatar/867ae57702dd9d4ebd40b2977e63497e?d=retro"},"created_at":"2023-02-23T12:45:02Z","body":"我也顶一下作者"}]</div><style>#comment-header,#comment-list>li{margin:1em auto}#comment-avatar,#comment-tip{margin:auto .2em}#comment-action-avatar,#comment-avatar{width:1em;height:1em}#comment-action-info>*,#comment-action-input>*,#comment-info>*{display:inline-block;vertical-align:middle}#comment-header{font-size:1.6em;font-weight:700;line-height:1.6em}#comment-tip{font-style:italic}#comment-list{list-style:none;padding:0}#comment-action-author,#comment-author{font-weight:700;margin:auto .4em}#comment-datetime{font-size:.8em;font-style:italic}#comment-body{margin:auto 1.8em}#comment-action-info>*{margin:1em .2em}#comment-action-input{height:2em;width:100%;margin:1em auto}#comment-action-input>*{height:100%;margin:0 .2em}#comment-action-textarea{width:calc(100% - 8em)}#comment-action-post{width:6em}#comment-action-login{margin:1em .3em}</style><ol id=comment-list></ol><div id=comment-action></div><script>const y=e=>{var t=/\\([\\\|`*_{}\[\]()#+\-~])/g,n=/\n *&gt; *([^]*?)(?=(\n|$){2})/g,i=/\n( *)(?:[*\-+]|((\d+)|([a-z])|[A-Z])[.)]) +([^]*?)(?=(\n|$){2})/g,o=/(^|[^A-Za-z\d\\])(([*_])|(~)|(\^)|(--)|(\+\+)|`)(\2?)([^<]*?)\2\8(?!\2)(?=\W|_|$)/g,a=/^.*\n( *\|( *:?-+:?-+:? *\|)* *\n|)/,c=/.*\n/g,m=/\||(.*?[^\\])\|/g;const l=(t,n)=>{e=e.replace(t,n)},d=(e,t)=>"<"+e+">"+t+"</"+e+">",r=e=>e.replace(n,((e,t)=>d("blockquote",r(u(t.replace(/^ *&gt; */gm,"")))))),s=e=>e.replace(i,((e,t,n,i,o,a)=>(e=d("li",u(a.split(RegExp("\n ?"+t+"(?:(?:\\d+|[a-zA-Z])[.)]|[*\\-+]) +","g")).map(s).join("</li><li>"))),"\n"+(n?'<ol start="'+(i?n+'">':parseInt(n,36)-9+'" style="list-style-type:'+(o?"low":"upp")+'er-alpha">')+e+"</ol>":d("ul",e))))),u=e=>e.replace(o,((e,t,n,i,o,a,c,m,l,r)=>t+d(i?l?"strong":"em":o?l?"s":"sub":a?"sup":c?"small":m?"big":"code",u(r))));var p=[],h=0;return e="\n"+e+"\n",l(/</g,"&lt;"),l(/>/g,"&gt;"),l(/\t|\r|\uf8ff/g,"  "),e=r(e),l(/^([*\-=_] *){3,}$/gm,"<hr/>"),e=s(e),l(/<\/(ol|ul)>\n\n<\1>/g,""),l(/\n((```|~~~).*\n?([^]*?)\n?\2|((    .*?\n)+))/g,((e,t,n,i,o)=>(p[--h]=d("pre",d("code",i||o.replace(/^    /gm,""))),h+""))),l(/((!?)\[(.*?)\]\((.*?)( ".*")?\)|\\([\\`*_{}\[\]()#+\-.!~]))/g,((e,n,i,o,a,c,m)=>(p[--h]=a?i?'<img src="'+a+'" alt="'+o+'"/>':'<a href="'+a+'">'+u(o).replace(t,"$1")+"</a>":m,h+""))),l(/&lt;(.*?)&gt;/g,((e,n)=>'<a href="'+n+'">'+u(n).replace(t,"$1")+"</a>")),l(/\n(( *\|.*?\| *\n)+)/g,((e,n)=>{var i=n.match(a)[1];return"\n"+d("table",n.replace(c,((e,n)=>e==i?"":d("tr",e.replace(m,((e,o,a)=>a?d(i&&!n?"th":"td",u(o||"").replace(t,"$1")):""))))))})),l(/(?=^|>|\n)([>\s]*?)(#{1,6}) (.*?)( #*)? *(?=\n|$)/g,((e,n,i,o)=>n+d("h"+i.length,u(o).replace(t,"$1")))),l(/(?=^|>|\n)\s*\n+([^<]+?)\n+\s*(?=\n|<|$)/g,((e,n)=>d("p",u(n).replace(t,"$1")))),l(/-\d+\uf8ff/g,(e=>p[parseInt(e,10)])),e.trim()},f=e=>{let t=t=>e.next(t),n=t=>e.throw(t);return new Promise(((i,o)=>{let a=e=>{e.done?i(e.value):Promise.resolve(e.value).then(t,n).then(a,o)};a(e.next())}))};let g;const m=document.getElementById("comments-issue-id").innerText,n=new URL(window.location.href);let q,p=n.searchParams.get("github_access_token");p&&(document.cookie=`github_access_token=${p};Path=/;Secure;SameSite=Strict`,n.searchParams.delete("github_access_token"),window.location.replace(n)),null!=p||(p=null==(q=document.cookie.split(";").find((e=>e.trim().startsWith("github_access_token="))))?void 0:q.trim().substring(20));const r=()=>{document.cookie="github_access_token=;expires=Thu, 01 Jan 1970 00:00:00 GMT;Path=/;Secure;SameSite=Strict",p=null},t=()=>f(function*(){var e;let n;if(g=JSON.parse(null!=(n=null==(e=document.getElementById("comments-addition"))?void 0:e.innerText)?n:"[]"),p){if(200!==(e=yield fetch(`https://comments.eaimty.com/comments?issue_id=${m}&github_access_token=${p}`,{method:"GET"})).status)return r(),yield t()}else e=yield fetch(`https://comments.eaimty.com/comments?issue_id=${m}`,{method:"GET"});200===e.status&&(g=g.concat(yield e.json()))}()),u=()=>{g.sort(((e,t)=>new Date(e.created_at).getTime()-new Date(t.created_at).getTime()));let e=document.getElementById("comment-list");e.innerHTML="";var t=document.createElement("div");for(t.id="comment-header",t.innerText="Comments",e.appendChild(t),0===g.length&&((t=document.createElement("div")).id="comment-tip",t.innerText="No comment yet",e.appendChild(t)),t=0;t<g.length;t++){let o=document.createElement("li");var n=document.createElement("div");n.id="comment-info";var i=document.createElement("img");i.id="comment-avatar",i.src=g[t].user.avatar_url,n.appendChild(i),(i=document.createElement("a")).id="comment-author",i.innerText=g[t].user.login,g[t].user.html_url&&(i.href=g[t].user.html_url),n.appendChild(i),(i=document.createElement("div")).id="comment-datetime",i.innerText=new Date(g[t].created_at).toLocaleString(),n.appendChild(i),o.appendChild(n),(n=document.createElement("div")).id="comment-body",n.innerHTML=y(g[t].body),o.appendChild(n),e.appendChild(o)}},v=()=>f(function*(){let e=document.getElementById("comment-action");e.innerHTML="";var n=document.createElement("div");if(n.id="comment-header",n.innerText="Leave a comment",e.appendChild(n),p){if(200===(n=yield fetch(`https://comments.eaimty.com/userinfo?github_access_token=${p}`,{method:"GET"})).status){n=yield n.json();let o=document.createElement("div");o.id="comment-action-info";var i=document.createElement("img");i.id="comment-action-avatar",i.src=n.avatar_url,o.appendChild(i),(i=document.createElement("a")).id="comment-action-author",i.innerText=n.login,i.href=n.html_url,o.appendChild(i);let a=document.createElement("button");a.id="comment-action-logout",a.innerText="Logout",a.addEventListener("click",(()=>{r(),v()})),o.appendChild(a),e.appendChild(o),(n=document.createElement("div")).id="comment-tip",n.innerText="Before commenting, please think about whether your comment is meaningful? Is it related to the topic? Is it rational and friendly? If you were someone else, would you feel uncomfortable seeing this comment?",e.appendChild(n),(n=document.createElement("div")).id="comment-action-input";let c=document.createElement("textarea");c.id="comment-action-textarea",c.placeholder="Leave a comment",n.appendChild(c);let l=document.createElement("button");return l.id="comment-action-post",l.innerText="Comment",l.addEventListener("click",(()=>f(function*(){a.disabled=!0,c.disabled=!0,l.disabled=!0;let e=c.value.trim();0!==e.length&&(201===(yield fetch(`https://comments.eaimty.com/comments?issue_id=${m}&github_access_token=${p}`,{method:"POST",body:JSON.stringify({body:e})})).status?t().then((()=>u())).then((()=>v())):(r(),yield v(),window.alert("Failed to post comment")))}()))),n.appendChild(l),void e.appendChild(n)}r()}(n=document.createElement("div")).id="comment-tip",n.innerText="Clicking the login button means you agree to use cookies to store your GitHub Access Token",e.appendChild(n),(n=document.createElement("button")).id="comment-action-login",n.innerText="Login with GitHub",n.addEventListener("click",(()=>window.location.replace(`https://comments.eaimty.com/login?redirect_uri=${window.location.href}`))),e.appendChild(n)}());t().then((()=>u())).then((()=>v()))</script></div>